<app-sidebar></app-sidebar>

<h2 class="nome-pagina">Clipes de Falhas</h2>

<div class="container-falhas">
  <div class="filtros">
    <div class="pesquisa">
      <i class="bi bi-search"></i>
      <input
        type="text"
        placeholder="Pesquisar por t√≠tulo ou descri√ß√£o"
        [(ngModel)]="filtroTexto"
      />
    </div>

    <div class="tipo">
      <select [(ngModel)]="filtroTipo">
        <option value="">Tipos de falha</option>
        <option *ngFor="let tipo of tiposFalha" [value]="tipo">
          {{ tipo }}
        </option>
      </select>
    </div>

    <div class="data">
      <input type="date" [(ngModel)]="filtroData" />
    </div>
  </div>

  <div *ngIf="isLoading" class="estado-container">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <span class="ms-3">Carregando clipes da API...</span>
  </div>

  <div *ngIf="!isLoading && errorMsg" class="estado-container">
    <div class="alert alert-danger" role="alert">
      <strong>ERRO:</strong> {{ errorMsg }}
    </div>
  </div>

  <div *ngIf="!isLoading && !errorMsg">
    <div class="conteudo" [class.expandido]="!falhaSelecionada">
      <ul
        class="lista-falhas"
        *ngIf="falhasFiltradas.length > 0; else semDados"
      >
        <li
          *ngFor="let falha of falhasFiltradas"
          (click)="selecionarFalha(falha)"
          [class.selecionada]="falha === falhaSelecionada"
        >
          <div class="selo" *ngIf="falha === falhaSelecionada"></div>
          <i [class]="falha.icone" [ngStyle]="{ color: getCor(falha) }"></i>
          <div>
            <strong>{{ falha.titulo }}</strong>
            <div class="data">{{ falha.data }}</div>
            <div class="descricao">
              {{ getDescricaoCurta(falha.descricao, 30) }}
            </div>
          </div>
        </li>
      </ul>

      <ng-template #semDados>
        <div class="estado-container">
          <div class="alert alert-info" role="alert">
            Nenhum clipe encontrado com os filtros atuais.
          </div>
        </div>
      </ng-template>

      <div class="detalhes" *ngIf="falhaSelecionada">
        <video controls [src]="falhaSelecionada.videoUrl">
          <source [src]="falhaSelecionada.videoUrl" type="video/mp4" />
          Seu navegador n√£o suporta v√≠deo.
        </video>

        <div class="info-bloco">
          <h3>{{ falhaSelecionada.titulo }}</h3>
          <ng-container *ngIf="!editMode; else modoEdicao">
            <ul class="descricao-detalhes">
              <li *ngIf="falhaSelecionada.raw.evidence && falhaSelecionada.raw.evidence['human_description']">
                <b>Descri√ß√£o (humana):</b> {{ falhaSelecionada.raw.evidence['human_description'] }}
              </li>
              <li><b>Categoria:</b> {{ falhaSelecionada.raw.category || '‚Äî' }}</li>
              <li><b>Tipo detectado:</b> {{ falhaSelecionada.raw.type || '‚Äî' }}</li>
              <li><b>Severidade:</b> {{ falhaSelecionada.raw.severity || '‚Äî' }}</li>
              <li><b>Confian√ßa:</b> {{ (falhaSelecionada.raw.confidence || 0) * 100 | number:'1.0-1' }}%</li>
              <li><b>Dura√ß√£o:</b> {{ falhaSelecionada.duracao }}</li>
              <li><b>In√≠cio:</b> {{ falhaSelecionada.raw.start_ts | date:'dd/MM/yyyy HH:mm:ss' }}</li>
              <li><b>Fim:</b> {{ falhaSelecionada.raw.end_ts | date:'dd/MM/yyyy HH:mm:ss' }}</li>
              <li><b>Clip:</b> {{ falhaSelecionada.videoUrl }}</li>
            </ul>
          </ng-container>
          <ng-template #modoEdicao>
            <div class="edicao">
              <label>Descri√ß√£o (humana)</label>
              <textarea [(ngModel)]="edicaoDescricao" rows="5" placeholder="Descreva o ocorrido por extenso..."></textarea>
              <div class="grid-edicao">
                <div>
                  <label>Categoria</label>
                  <input [(ngModel)]="edicaoCategoria" placeholder="Ex.: V√≠deo T√©cnico" />
                </div>
                <div>
                  <label>Tipo detectado</label>
                  <input [(ngModel)]="edicaoTipo" placeholder="Ex.: Bloco, Ru√≠do..." />
                </div>
                <div>
                  <label>Dura√ß√£o (s)</label>
                  <input [(ngModel)]="edicaoDuracao" placeholder="Ex.: 10.0" />
                </div>
              </div>
              <div class="botoes-edicao">
                <button class="btn-verde" (click)="salvarEdicao()">üíæ Salvar</button>
                <button class="btn-vermelho" (click)="editMode=false">‚úñÔ∏è Cancelar</button>
              </div>
            </div>
          </ng-template>
        </div>

        <div class="acoes">
          <button class="btn-azul" (click)="downloadClip(falhaSelecionada!)">
            ‚¨áÔ∏è Download Clipe
          </button>
          <button class="btn-azul" (click)="editMode=true" *ngIf="!editMode">‚úèÔ∏è Editar manualmente</button>
        </div>
      </div>
    </div>
    <div class="paginacao-container" *ngIf="falhasFiltradas.length > 0">
      <button
        class="btn-paginacao"
        (click)="paginaAnterior()"
        [disabled]="paginaAtual === 1"
      >
        Anterior
      </button>

      <span class="pagina-info">{{ paginaAtual }} de {{ totalPaginas }}</span>

      <button
        class="btn-paginacao"
        (click)="proximaPagina()"
        [disabled]="paginaAtual === totalPaginas"
      >
        Pr√≥ximo
      </button>

      <div class="paginacao-separador">‚Ä¢</div>
      <div class="paginacao-separador">‚Ä¢</div>

      <div class="menu-itens">
        <button class="menu-btn" (click)="toggleDropdown()">
          <i class="bi bi-list"></i>
        </button>

        <div
          class="dropdown-itens"
          [style.display]="mostrarDropdown ? 'flex' : 'none'"
        >
          <label>Itens por p√°gina</label>
          <select
            [value]="itensPorPagina"
            (change)="mudarItensPorPagina($event)"
          >
            <option [value]="10">10</option>
            <option [value]="20">20</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>
      
    </div>
  </div>
</div>


