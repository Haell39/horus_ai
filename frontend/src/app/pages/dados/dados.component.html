<app-sidebar></app-sidebar>

<div class="conteudo-dados">
  <h2 class="titulo-pagina">Dados de Falhas</h2>

  <div *ngIf="ocorrencias$ | async as ocorrencias; else loadingOrError">
    <div class="filtros-container">
      <div class="filtro">
        <label>Período:</label>
        <select [(ngModel)]="periodoSelecionado" (change)="aplicarFiltros()">
          <option value="7d">Últimos 7 dias</option>
          <option value="30d">Últimos 30 dias</option>
          <option value="2m">Últimos 2 meses</option>
        </select>
      </div>

      <div class="filtro">
        <label>Tipo de Erro:</label>
        <select [(ngModel)]="tipoErroSelecionado" (change)="aplicarFiltros()">
          <option value="todos">Todos</option>
          <option value="grave">Erro Grave</option>
          <option value="simples">Erro Simples</option>
        </select>
      </div>
    </div>

    <div class="dashboard-container">
      <div class="coluna-esquerda">
        <div class="card-grafico grande">
          <h3 class="titulo-grafico">Volume de Erros ao Longo do Tempo</h3>
          <apx-chart
            #barChart
            [series]="$any(barChartOptions).series"
            [chart]="$any(barChartOptions).chart"
            [plotOptions]="$any(barChartOptions).plotOptions"
            [dataLabels]="$any(barChartOptions).dataLabels"
            [stroke]="$any(barChartOptions).stroke"
            [xaxis]="$any(barChartOptions).xaxis"
            [yaxis]="$any(barChartOptions).yaxis"
            [fill]="$any(barChartOptions).fill"
            [tooltip]="$any(barChartOptions).tooltip"
            [legend]="$any(barChartOptions).legend"
          ></apx-chart>
        </div>
        <div class="card-grafico grande" style="margin-top: 18px">
          <h3 class="titulo-grafico">Ocorrências por Hora do Dia</h3>
          <apx-chart
            #hourChart
            [series]="$any(hourChartOptions).series"
            [chart]="$any(hourChartOptions).chart"
            [plotOptions]="$any(hourChartOptions).plotOptions"
            [dataLabels]="$any(hourChartOptions).dataLabels"
            [stroke]="$any(hourChartOptions).stroke"
            [xaxis]="$any(hourChartOptions).xaxis"
            [yaxis]="$any(hourChartOptions).yaxis"
            [fill]="$any(hourChartOptions).fill"
            [tooltip]="$any(hourChartOptions).tooltip"
            [legend]="$any(hourChartOptions).legend"
          ></apx-chart>
        </div>
      </div>

      <div class="coluna-direita">
        <div class="kpi-stack">
          <div class="card-grafico kpi" style="margin-bottom: 12px">
            <div class="kpi-inner">
              <div class="kpi-text">
                <div class="kpi-title">Total de Ocorrências</div>
                <div class="kpi-value">{{ kpiTotalCount }}</div>
                <div class="kpi-delta">
                  <span
                    *ngIf="kpiTotalDelta !== null"
                    [ngClass]="{
                      positive: kpiTotalDelta > 0,
                      negative: kpiTotalDelta < 0
                    }"
                  >
                    {{ kpiTotalDelta | number : "1.0-0" }}
                  </span>
                  <span *ngIf="kpiTotalDelta === null">—</span>
                </div>
              </div>
              <div class="kpi-sparkline">
                <apx-chart
                  #kpiTotalSparkline
                  [series]="kpiTotalSparklineSeries"
                  [chart]="kpiTotalSparklineOptions.chart"
                  [stroke]="kpiTotalSparklineOptions.stroke"
                  [fill]="kpiTotalSparklineOptions.fill"
                  [colors]="kpiTotalSparklineOptions.colors"
                ></apx-chart>
              </div>
            </div>
          </div>

          <div class="card-grafico kpi" style="margin-bottom: 14px">
            <div class="kpi-inner">
              <div class="kpi-text">
                <div class="kpi-title">% Ocorrências Graves</div>
                <div class="kpi-value">
                  {{ kpiPercentGraves | number : "1.1-1" }}%
                </div>
                <div class="kpi-delta">
                  <span
                    *ngIf="kpiDeltaPercent !== null"
                    [ngClass]="{
                      positive: kpiDeltaPercent > 0,
                      negative: kpiDeltaPercent < 0
                    }"
                  >
                    {{ kpiDeltaPercent | number : "1.1-1" }}%
                  </span>
                  <span *ngIf="kpiDeltaPercent === null">—</span>
                </div>
              </div>
              <div class="kpi-sparkline">
                <apx-chart
                  #kpiSparkline
                  [series]="kpiSparklineSeries"
                  [chart]="kpiSparklineOptions.chart"
                  [stroke]="kpiSparklineOptions.stroke"
                  [fill]="kpiSparklineOptions.fill"
                  [colors]="kpiSparklineOptions.colors"
                ></apx-chart>
              </div>
            </div>
          </div>
        </div>
        <div class="card-grafico combinado">
          <div class="parte-superior">
            <h3 class="titulo-grafico">Distribuição de Tipos de Erro</h3>
            <apx-chart
              #donutChart
              [series]="$any(donutChartOptions).series"
              [chart]="$any(donutChartOptions).chart"
              [labels]="$any(donutChartOptions).labels"
              [responsive]="$any(donutChartOptions).responsive"
              [dataLabels]="$any(donutChartOptions).dataLabels"
              [legend]="$any(donutChartOptions).legend"
              [colors]="$any(donutChartOptions).colors"
            ></apx-chart>
          </div>

          <div class="parte-inferior">
            <h3 class="titulo-grafico">Maiores Erros</h3>
            <apx-chart
              #horizontalChart
              [series]="$any(horizontalChartOptions).series"
              [chart]="$any(horizontalChartOptions).chart"
              [dataLabels]="$any(horizontalChartOptions).dataLabels"
              [plotOptions]="$any(horizontalChartOptions).plotOptions"
              [xaxis]="$any(horizontalChartOptions).xaxis"
              [legend]="$any(horizontalChartOptions).legend"
              [yaxis]="$any(horizontalChartOptions).yaxis"
              [fill]="$any(horizontalChartOptions).fill"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>
  </div>
  <ng-template #loadingOrError>
    <div
      *ngIf="errorMsg"
      class="alert alert-danger"
      role="alert"
      style="margin: 15px"
    >
      <strong>ERRO:</strong> {{ errorMsg }}
    </div>

    <div
      *ngIf="!errorMsg"
      class="d-flex justify-content-center align-items-center mt-5"
      style="color: white; min-height: 300px"
    >
      <div
        class="spinner-border text-light"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Carregando dados...</span>
      </div>
      <span class="ms-3 fs-4">Carregando dados da API...</span>
    </div>
  </ng-template>
</div>
